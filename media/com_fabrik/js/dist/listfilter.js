/*! Fabrik */

define(["jquery","fab/fabrik","fab/advanced-search"],function(h,d,r){return new Class({Implements:[Events],options:{container:"",filters:[],type:"list",id:"",ref:"",advancedSearch:{controller:"list"}},initialize:function(t){var a=this;this.filters={},this.options=h.extend(this.options,t),this.advancedSearch=!1,this.container=h("#"+this.options.container),this.filterContainer=this.container.find(".fabrikFilterContainer"),this.filtersInHeadings=this.container.find(".listfilter");var e=this.container.find(".toggleFilters");if(e.on("click",function(t){t.preventDefault(),a.filterContainer.toggle(),a.filtersInHeadings.toggle()}),0<e.length&&(this.filterContainer.hide(),this.filtersInHeadings.toggle()),0!==this.container.length){this.getList();var i=this.container.find(".clearFilters");i.off(),i.on("click",function(t){t.preventDefault(),a.container.find(".fabrik_filter").each(function(t,e){a.clearAFilter(h(e))}),a.clearPlugins(),a.submitClearForm()}),this.container.find(".advanced-search-link").on("click",function(t){t.preventDefault();var e,i=h(t.target);"A"!==i.prop("tagName")&&(i=i.closest("a"));var n=i.prop("href");n+="&listref="+a.options.ref,e={id:"advanced-search-win"+a.options.ref,modalId:"advanced-filter",title:Joomla.JText._("COM_FABRIK_ADVANCED_SEARCH"),loadMethod:"xhr",evalScripts:!0,contentURL:n,width:710,height:340,y:a.options.popwiny,onContentLoaded:function(){var t=d.blocks["list_"+a.options.ref];void 0===t&&(t=d.blocks[a.options.container],a.options.advancedSearch.parentView=a.options.container),t.advancedSearch=new r(a.options.advancedSearch),this.fitToContent(!1)}},d.getWindow(e)}),h(".fabrik_filter.advancedSelect").on("change",{changeEvent:"change"},function(t){this.fireEvent(t.data.changeEvent,new Event.Mock(document.getElementById(this.id),t.data.changeEvent))}),this.watchClearOne()}},getList:function(){return this.list=d.blocks[this.options.type+"_"+this.options.ref],void 0===this.list&&(this.list=d.blocks[this.options.container]),this.list},addFilter:function(t,e){!1===this.filters.hasOwnProperty(t)&&(this.filters[t]=[]),this.filters[t].push(e)},onSubmit:function(){this.filters.date&&h.each(this.filters.date,function(t,e){e.onSubmit()}),this.showFilterState()},onUpdateData:function(){this.filters.date&&h.each(this.filters.date,function(t,e){e.onUpdateData()})},getFilterData:function(){var e={};return this.container.find(".fabrik_filter").each(function(){if(void 0!==h(this).prop("id")&&h(this).prop("id").test(/value$/)){var t=h(this).prop("id").match(/(\S+)value$/)[1];"SELECT"===h(this).prop("tagName")&&-1!==this.selectedIndex?e[t]=h(this.options[this.selectedIndex]).text():e[t]=h(this).val(),e[t+"_raw"]=h(this).val()}}),e},update:function(){h.each(this.filters,function(t,e){e.each(function(t){t.update()})})},clearAFilter:function(t){var e;(t.prop("name").contains("[value]")||t.prop("name").contains("fabrik_list_filter_all")||t.hasClass("autocomplete-trigger"))&&("SELECT"===t.prop("tagName")?(e=t.prop("multiple")?-1:0,t.prop("selectedIndex",e)):"checkbox"===t.prop("type")?t.prop("checked",!1):t.val(""))},clearPlugins:function(){var t=this.getList().plugins;null!==t&&t.each(function(t){t.clearFilter()})},submitClearForm:function(){var t="FORM"===this.container.prop("tagName")?this.container:this.container.find("form");h("<input />").attr({name:"resetfilters",value:1,type:"hidden"}).appendTo(t),"list"===this.options.type?this.list.submit("list.clearfilter"):this.container.find("form[name=filter]").submit()},watchClearOne:function(){var n=this;this.container.find("*[data-filter-clear]").on("click",function(t){t.stopPropagation();var e=t.event?t.event.currentTarget:t.currentTarget,i=h(e).data("filter-clear");h('*[data-filter-name="'+i+'"]').each(function(t,e){n.clearAFilter(h(e))}),n.submitClearForm(),n.showFilterState()})},showFilterState:function(){var n,a,r,o=h(d.jLayouts["modal-state-label"]),s=this,l=!1,c=this.container.find("*[data-modal-state-display]");0!==c.length&&(c.empty(),h.each(this.options.filters,function(t,e){var i=s.container.find('*[data-filter-name="'+e.name+'"]');"SELECT"===i.prop("tagName")&&-1!==i[0].selectedIndex?(a=h(i[0].options[i[0].selectedIndex]).text(),r=i.val()):a=r=i.val(),null!=a&&""!==a&&""!==r&&(l=!0,(n=o.clone()).find("*[data-filter-clear]").data("filter-clear",e.name),n.find("*[data-modal-state-label]").text(e.label),n.find("*[data-modal-state-value]").text(a),c.append(n))}),l?this.container.find("*[data-modal-state-container]").show():this.container.find("*[data-modal-state-container]").hide(),this.watchClearOne())},updateFilterCSS:function(t){var e=this.container.find(".clearFilters");e&&(t.hasFilters?e.addClass("hasFilters"):e.removeClass("hasFilters"))}})});